platform: linux
image_resource:
  type: registry-image
  source: {repository: amidos/dcind}
inputs:
- name: postgres-11
- name: go-1.14
- name: repo
caches:
- path: go-module-cache
run:
  path: bash
  args:
  - -ec
  - |
    source /docker-lib.sh
    start_docker
    echo "Loading postgres:11-alpine..." && docker load -i postgres-11/image.tar
    echo "Loading golang:1.14..." && docker load -i go-1.14/image.tar
    docker-compose \
      -f repo/docker-compose.yml \
      run \
      -v $PWD/repo:/src \
      -v $PWD/go-module-cache:/root/go/pkg/mod \
      -w /src \
      tests go test ./...
